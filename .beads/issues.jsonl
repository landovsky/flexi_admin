{"id":"flexi_admin_-cq9","title":"Implement comprehensive test coverage strategy for flexi_admin gem","description":"Implement comprehensive test coverage strategy for flexi_admin gem including integration tests, ViewComponent tests, controller tests, and JavaScript tests. Must perform end-to-end testing as per ui-test-cases.md and generate human-readable RSpec documentation output.","status":"open","priority":2,"issue_type":"feature","owner":"landovsky@gmail.com","created_at":"2026-02-02T12:06:49.750486+01:00","created_by":"Tomáš Landovský","updated_at":"2026-02-02T12:06:49.750486+01:00"}
{"id":"flexi_admin_-cq9.1","title":"Plan test coverage implementation strategy","status":"closed","priority":1,"issue_type":"task","owner":"claude@sandbox.local","created_at":"2026-02-02T15:46:00.77049521Z","created_by":"Claude (Sandbox)","updated_at":"2026-02-02T15:49:01.589436868Z","closed_at":"2026-02-02T15:48:36.213433274Z","close_reason":"Completed comprehensive planning - ready for implementation","dependencies":[{"issue_id":"flexi_admin_-cq9.1","depends_on_id":"flexi_admin_-cq9","type":"parent-child","created_at":"0001-01-01T00:00:00Z"}],"comments":[{"id":1,"issue_id":"flexi_admin_-cq9.1","author":"Claude (Sandbox)","text":"# Plan: Comprehensive Test Coverage Implementation for flexi_admin Gem\n\n## Branch\n`feature/cq9.1-test-coverage-strategy`\n\n## Overview\nThis plan establishes a comprehensive test infrastructure for the flexi_admin Rails Engine gem, implementing end-to-end integration tests based on ui-test-cases.md, along with ViewComponent tests, controller tests, and JavaScript tests. The gem currently has minimal testing (only 2 spec files), and this implementation will create a robust test foundation with RSpec documentation output for human-readable test coverage reports.\n\n## Key Infrastructure Requirements\n\nThe flexi_admin gem is a Rails Engine (isolated namespace) with:\n- 51 ViewComponents with Slim templates\n- 17 Stimulus JavaScript controllers  \n- Controller concerns (ResourcesController, ModalsController)\n- Pure Ruby models (Struct, ContextParams, Toast, Context)\n- Service objects (CreateResource, UpdateResource)\n- Dependencies: Rails 7.1+, ViewComponent 3.20, will_paginate, slim-rails\n\n**Critical requirement:** Must create a dummy Rails application within spec/ to test Rails-dependent components and integration scenarios.\n\n## Files to Create/Modify\n\n### Phase 1: Test Infrastructure Setup\n\n- [ ] **flexi_admin.gemspec** - Add test dependencies:\n  - `capybara` (~\u003e 3.39) for integration testing\n  - `selenium-webdriver` (~\u003e 4.15) for browser automation\n  - `webdrivers` (~\u003e 5.3) for driver management\n  - `factory_bot_rails` (~\u003e 6.4) for test data\n  - `database_cleaner-active_record` (~\u003e 2.1) for test isolation\n  - `rspec-rails` (already present, verify version ~\u003e 6.1)\n  - Keep as development dependencies\n\n- [ ] **spec/rails_helper.rb** - New Rails test environment bootstrap:\n  - Load dummy Rails app from spec/dummy/config/environment\n  - Require rspec/rails and support files\n  - Include ViewComponent::TestHelpers and Capybara::DSL\n  - Configure DatabaseCleaner with transaction strategy\n  - Set up FactoryBot syntax methods\n  - Configure Capybara with selenium driver\n  - Load I18n with flexi_admin locales\n  - Configure RSpec to use --format documentation (already in .rspec)\n\n- [ ] **spec/support/view_component_helpers.rb** - ViewComponent test utilities\n- [ ] **spec/support/factory_bot.rb** - FactoryBot configuration  \n- [ ] **spec/support/database_cleaner.rb** - DatabaseCleaner hooks\n\n### Phase 2: Dummy Rails Application\n\nCreate a minimal Rails 7.1 app structure under spec/dummy/:\n\n- [ ] **spec/dummy/config/application.rb** - Rails app with FlexiAdmin engine mounted\n- [ ] **spec/dummy/config/boot.rb** - Bundler setup\n- [ ] **spec/dummy/config/environment.rb** - Environment initialization  \n- [ ] **spec/dummy/config/environments/test.rb** - Test environment config\n- [ ] **spec/dummy/config/database.yml** - SQLite3 in-memory database\n- [ ] **spec/dummy/config/routes.rb** - Mount engine + define admin routes\n- [ ] **spec/dummy/config/initializers/flexi_admin.rb** - Configure namespace as :admin\n\n- [ ] **spec/dummy/app/models/application_record.rb** - Base model\n- [ ] **spec/dummy/app/models/user.rb** - Test model with ApplicationResource concern\n- [ ] **spec/dummy/app/models/comment.rb** - Child model for nested tests\n\n- [ ] **spec/dummy/app/controllers/application_controller.rb** - Base controller\n- [ ] **spec/dummy/app/controllers/admin/users_controller.rb** - Uses ResourcesController concern\n- [ ] **spec/dummy/app/controllers/admin/comments_controller.rb** - Nested resource controller\n\n- [ ] **spec/dummy/db/migrate/001_create_users.rb** - User table migration\n- [ ] **spec/dummy/db/migrate/002_create_comments.rb** - Comment table migration  \n- [ ] **spec/dummy/db/schema.rb** - Schema definition\n\n- [ ] **spec/factories/users.rb** - User factory\n- [ ] **spec/factories/comments.rb** - Comment factory\n\n### Phase 3: Integration Tests (UI Test Cases)\n\nMap ui-test-cases.md scenarios to RSpec integration tests:\n\n- [ ] **spec/integration/users_list_spec.rb** - Users List Page (UL-001 to UL-020):\n  - Search \u0026 Filter scenarios (UL-001 to UL-005)\n  - Sorting scenarios (UL-006 to UL-009)  \n  - Selection \u0026 Bulk Actions (UL-010 to UL-014)\n  - Pagination \u0026 Layout (UL-015 to UL-020)\n\n- [ ] **spec/integration/user_detail_spec.rb** - User Detail Page (UD-001 to UD-009):\n  - Navigation \u0026 Layout (UD-001 to UD-002)\n  - Data Display \u0026 Interaction (UD-003 to UD-006)\n  - Actions (UD-007 to UD-009)\n\n### Phase 4: ViewComponent Tests\n\nStart with components used in UI test cases:\n\n- [ ] **spec/components/resources/index_page_component_spec.rb** - Main index page wrapper\n- [ ] **spec/components/resources/resources_component_spec.rb** - Resources listing container\n- [ ] **spec/components/resources/list_view/table_component_spec.rb** - Table view\n- [ ] **spec/components/resources/pagination_component_spec.rb** - Pagination controls\n- [ ] **spec/components/resources/view_component_spec.rb** - View switching UI\n- [ ] **spec/components/resources/bulk_action/button_component_spec.rb** - Bulk action trigger\n- [ ] **spec/components/shared/link_component_spec.rb** - Link rendering\n- [ ] **spec/components/nav/breadcrumbs_component_spec.rb** - Breadcrumb navigation\n\n### Phase 5: Controller Tests\n\n- [ ] **spec/requests/resources_controller_spec.rb** - Test ResourcesController concern:\n  - CRUD actions (index, show, create, update, destroy)\n  - Context params handling\n  - Parent/child relationships via GlobalID\n  - Turbo Stream responses\n  - Bulk action processing\n\n### Phase 6: JavaScript Tests\n\n- [ ] **package.json** - Update with test dependencies:\n  - `jest` (~\u003e 29.7)\n  - `@testing-library/dom` (~\u003e 9.3)\n  - `jsdom` (~\u003e 23.0)\n  - Add test script: `\"test\": \"jest\"`\n\n- [ ] **jest.config.js** - Jest configuration for Stimulus testing\n\n- [ ] **spec/javascript/controllers/bulk_action_controller.test.js** - Priority test:\n  - sessionStorage persistence (per lessons-learned.md)\n  - Selection toggling\n  - Cross-pagination state\n  - UI updates (counter, selection text)\n\n- [ ] **spec/javascript/controllers/pagination_controller.test.js**\n- [ ] **spec/javascript/controllers/sorting_controller.test.js**\n- [ ] **spec/javascript/controllers/filter_auto_submit_controller.test.js**\n\n### Phase 7: Documentation Output\n\n- [ ] **.rspec** - Already configured with `--format documentation`\n- [ ] **README.md** - Add testing section with:\n  - Running tests: `bundle exec rspec`\n  - Generate documentation: `bundle exec rspec --format documentation --out spec_docs.txt`\n  - JavaScript tests: `npm test`\n  - Running specific test types\n\n- [ ] **spec/spec_documentation_generator.rake** - Rake task to generate human-readable test docs\n\n## Watch Out For\n\n### Rails Engine Testing Complexity\n- **Risk:** Engine testing requires mounting in a host Rails app, which is more complex than standard Rails testing\n- **How to avoid:** The dummy app pattern is the standard approach used by other engine gems (Devise, Kaminari). Follow spec/dummy structure carefully. The dummy app must properly configure FlexiAdmin::Config.configuration.namespace.\n\n### ViewComponent Rendering Dependencies  \n- **Risk:** Components depend on Rails helpers (main_app, polymorphic_path) and ContextParams objects\n- **How to avoid:** Always load rails_helper for component tests, not spec_helper. Create test helper methods in spec/support/view_component_helpers.rb to build valid ContextParams instances. Reference pattern from lib/flexi_admin/components/resources/pagination_component.rb (lines 47-61) showing how components use context.params.\n\n### GlobalID Configuration for Test Models\n- **Risk:** Parent/child relationships use GlobalID for serialization, but test models won't be registered by default\n- **How to avoid:** Test models MUST include FlexiAdmin::Concerns::ApplicationResource. The dummy app initializer must ensure GlobalID is configured. See lib/flexi_admin/controllers/resources_controller.rb lines 276-296 for locate_resource implementation that depends on GlobalID::Locator.\n\n### Stimulus Controller Event Listener Cleanup\n- **Risk:** Document-level event listeners in Stimulus controllers can leak between tests if not properly removed\n- **How to avoid:** From lessons-learned.md: Always bind event handlers in connect() and store reference for proper cleanup in disconnect(). Example in lib/flexi_admin/javascript/controllers/bulk_action_controller.js lines 15-17, 24-25. Mock sessionStorage in JavaScript tests.\n\n### Scope Identifier Consistency\n- **Risk:** Different components may use different identifiers for the same resource (singular vs plural)\n- **How to avoid:** From lessons-learned.md: Always use context.scope (plural) for bulk actions, not resource.class.name.downcase (singular). This bug caused grid view vs list view selection persistence issues.\n\n### Turbo Frame Integration\n- **Risk:** Many components render turbo_stream responses that require proper Turbo setup in tests\n- **How to avoid:** Capybara must be configured with a JavaScript driver (selenium). Request specs must test both HTML and turbo_stream formats. See lib/flexi_admin/controllers/resources_controller.rb lines 36-53 for render_index dual format pattern.\n\n### I18n Configuration\n- **Risk:** Components use Czech locales (e.g., \"Zrušit\", \"Celé jméno\") from config/locales/\n- **How to avoid:** rails_helper must load FlexiAdmin engine's locale files. The dummy app's config/application.rb must configure I18n properly. Tests should use I18n.t() with flexi_admin scope.\n\n## Dependencies and Integration Points\n\n### Component Pattern to Follow\nLook at lib/flexi_admin/components/resources/pagination_component.rb:\n- Uses BaseComponent as parent (line 4)\n- Includes ResourceHelper and UrlHelper (lines 7-8)  \n- Accepts context with resources, parent, params (lines 12-19)\n- Uses context.params.merge() for building paths (lines 48-50, 56-58)\n- This pattern appears across all resource components\n\n### Controller Concern Pattern\nLook at lib/flexi_admin/controllers/resources_controller.rb:\n- Included as concern (line 4: extend ActiveSupport::Concern)\n- Uses before_action for context_params (line 10)\n- Methods like render_index respond to both format.html and format.turbo_stream (lines 40-52)\n- Uses namespaced_class helper to find components dynamically (lines 41, 47)\n- Bulk actions parse JSON ids from params (line 219)\n\n### JavaScript Controller Pattern  \nLook at lib/flexi_admin/javascript/controllers/bulk_action_controller.js:\n- Extends Stimulus Controller (line 5)\n- Defines static values and targets (lines 6-11)\n- Uses sessionStorage with scoped keys (lines 211-213)\n- Binds event listeners with stored references (lines 15-17, 24-25)\n- Updates UI conditionally with hasXxxTarget checks (lines 256-269)\n\n## Testing Approach\n\n### Integration Tests Strategy\nFor ui-test-cases.md scenarios:\n- Use Capybara feature specs with JavaScript driver\n- Create realistic data with FactoryBot (10-50 users for pagination)\n- Test actual user workflows (search → sort → select → bulk action)\n- Verify UI state changes (counter updates, selection persistence)\n- Test across page navigation (pagination retains selections per lessons-learned.md)\n\n### ViewComponent Tests Strategy  \n- Use render_inline() from ViewComponent::TestHelpers\n- Test rendered HTML with Capybara matchers (have_css, have_text)\n- For components with slots, test with block syntax\n- Mock ContextParams with minimal valid data\n- Test edge cases (nil values, empty collections, no permissions)\n\n### Controller Tests Strategy\n- Use request specs (not controller specs - Rails 7+ best practice)\n- Test via dummy app routes (e.g., /admin/users)\n- Verify both HTML and Turbo Stream responses\n- Test authorization paths (if CanCan defined)\n- Test GlobalID parent propagation for nested resources\n\n### JavaScript Tests Strategy\n- Use Jest with jsdom environment\n- Mock sessionStorage/localStorage\n- Test Stimulus lifecycle (connect, disconnect)  \n- Test action handlers triggered by events\n- Verify DOM updates and data attribute changes\n- For bulk_action_controller: Test persistence patterns from lessons-learned.md\n\n## RSpec Documentation Output\n\nThe .rspec file already has `--format documentation` configured. To generate human-readable output:\n\n```bash\n# Run all tests with documentation output\nbundle exec rspec --format documentation\n\n# Save to file for review\nbundle exec rspec --format documentation --out spec_documentation.txt\n\n# Generate HTML report (requires rspec_html_formatter gem)\nbundle exec rspec --format html --out spec_report.html\n```\n\nConsider adding SimpleCov for coverage reporting in spec/rails_helper.rb:\n```ruby\nrequire 'simplecov'\nSimpleCov.start 'rails' do\n  add_filter '/spec/'\n  add_filter '/config/'\nend\n```\n\n## Implementation Order\n\n1. **Phase 1 + Phase 2** (Infrastructure + Dummy App) - Must complete together, can't test anything without this\n2. **Phase 3** (Integration Tests) - Highest priority per requirements, implements ui-test-cases.md\n3. **Phase 4** (ViewComponent Tests) - Run in parallel with Phase 3 after infrastructure is ready\n4. **Phase 5** (Controller Tests) - After components are tested\n5. **Phase 6** (JavaScript Tests) - Can run in parallel after Phase 1, independent of Ruby tests\n6. **Phase 7** (Documentation) - Final touches after tests are passing\n\n## Success Criteria\n\n- [ ] All UI test cases from artifacts/ui-test-cases.md are covered (UL-001 through UL-020, UD-001 through UD-009)\n- [ ] Integration tests run with Capybara + Selenium and pass\n- [ ] ViewComponent tests cover main components used in UI flows\n- [ ] Controller tests verify CRUD operations and Turbo Stream responses\n- [ ] JavaScript tests cover bulk_action_controller with sessionStorage persistence\n- [ ] `bundle exec rspec` runs successfully and generates documentation output\n- [ ] README includes clear testing instructions\n- [ ] Tests run successfully in fresh checkout (db migrations, asset compilation)\n\n## Lessons from Past Work\n\nFrom .claude/lessons-learned.md:\n- Always bind and store document-level event listeners for proper cleanup\n- Use sessionStorage for Turbo frame state persistence pattern\n- Ensure scope identifiers are consistent (use context.scope, not resource.class.name)\n- Check for optional targets with hasXxxTarget before manipulating UI elements","created_at":"2026-02-02T15:48:32.55765603Z"}]}
{"id":"flexi_admin_-cq9.2","title":"Implement test suite","status":"in_progress","priority":1,"issue_type":"task","owner":"claude@sandbox.local","created_at":"2026-02-02T15:46:01.598710288Z","created_by":"Claude (Sandbox)","updated_at":"2026-02-02T15:49:02.261072268Z","dependencies":[{"issue_id":"flexi_admin_-cq9.2","depends_on_id":"flexi_admin_-cq9","type":"parent-child","created_at":"0001-01-01T00:00:00Z"},{"issue_id":"flexi_admin_-cq9.2","depends_on_id":"flexi_admin_-cq9.1","type":"blocks","created_at":"0001-01-01T00:00:00Z"}]}
{"id":"flexi_admin_-cq9.3","title":"Review and validate test coverage","status":"open","priority":1,"issue_type":"task","owner":"claude@sandbox.local","created_at":"2026-02-02T15:46:02.941722692Z","created_by":"Claude (Sandbox)","updated_at":"2026-02-02T15:46:02.941722692Z","dependencies":[{"issue_id":"flexi_admin_-cq9.3","depends_on_id":"flexi_admin_-cq9","type":"parent-child","created_at":"0001-01-01T00:00:00Z"},{"issue_id":"flexi_admin_-cq9.3","depends_on_id":"flexi_admin_-cq9.2","type":"blocks","created_at":"0001-01-01T00:00:00Z"}]}
